version: 2
jobs:
  {% for build in builds %}
  "build {{ build['tag'] }}":
    machine:
      enabled: true
    steps:
      - checkout
      - run:
          name: Build container
          command: docker build -t {{ build['image_name'] }}:{{ build['tag'] }} dockerfiles/{{ build['filename'] | dirname }}/.
      - run:
          name: Test container
          command: |
            docker run {{ build['image_name'] }}:{{ build['image_name'] }}:{{ build['tag'] }} python --version
            docker run {{ build['image_name'] }}:{{ build['tag'] }} node --version
      - run:
          name: Push container if master
          command: |
            if [ "$CIRCLE_BRANCH" != "master" ]; then
              echo "Not pushing because we're not on master"
              exit 0
            fi

            echo "$DOCKER_HUB_PASSWORD" | docker login --username airhorns --password-stdin
            docker push {{ build['image_name'] }}:{{ build['tag'] }}

            {% for alias_tag in build['alias_tags'] %}
            docker tag {{ build['image_name'] }}:{{ build['tag'] }} {{ alias_tag }}
            docker push {{ build['image_name'] }}:{{ alias_tag }}
            {% endfor %}
  {% endfor %}

workflows:
  version: 2
  build:
    jobs:
    {% for build in builds %}
      - "build {{ build['tag'] }}"
    {% endfor %}
